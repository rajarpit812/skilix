<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Skilix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #message-box {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        #message-box.show { opacity: 1; visibility: visible; }
        #modify-modal {
             max-height: 90vh;
             overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="admin-dashboard" class="hidden">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="index.html" class="font-bold text-2xl">Skil<span class="text-indigo-600">ix</span> Admin</a>
                <div>
                    <span id="admin-name" class="mr-4 text-gray-700"></span>
                    <a href="index.html" class="text-gray-600 hover:text-indigo-600">Go to Homepage</a>
                </div>
            </nav>
        </header>

        <main class="container mx-auto px-6 py-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Admin Dashboard</h1>

            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">Manage Internships</h2>
                <details>
                    <summary class="cursor-pointer font-semibold text-indigo-600">Click to Create a New Internship</summary>
                    <form id="internship-form" class="mt-4">
                        <div class="mb-4"><label for="title" class="block text-gray-700 font-medium mb-2">Internship Title</label><input type="text" id="title" class="w-full px-4 py-2 border rounded-lg" required></div>
                        <div class="mb-4"><label for="headline" class="block text-gray-700 font-medium mb-2">Headline</label><input type="text" id="headline" class="w-full px-4 py-2 border rounded-lg" required></div>
                        <div class="mb-4"><label for="briefIntro" class="block text-gray-700 font-medium mb-2">Brief Intro</label><textarea id="briefIntro" rows="2" class="w-full px-4 py-2 border rounded-lg" required></textarea></div>
                        <div class="mb-4"><label for="description" class="block text-gray-700 font-medium mb-2">Description</label><textarea id="description" rows="4" class="w-full px-4 py-2 border rounded-lg" required></textarea></div>
                        <div class="mb-4"><label for="domain" class="block text-gray-700 font-medium mb-2">Domain</label><input type="text" id="domain" class="w-full px-4 py-2 border rounded-lg" required></div>
                        <div class="mb-4"><label for="logoUrl" class="block text-gray-700 font-medium mb-2">Logo URL</label><input type="url" id="logoUrl" class="w-full px-4 py-2 border rounded-lg"></div>
                        <button type="submit" id="add-internship-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">Add Internship</button>
                    </form>
                </details>
                <div id="internships-list" class="space-y-4 mt-6"></div>
            </section>

            <section class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Users & Applications</h2>
                <div class="mb-4"><input type="text" id="user-search" placeholder="Search by name or email..." class="w-full px-4 py-2 border rounded-lg"></div>
                <div id="users-list" class="space-y-6"></div>
            </section>
        </main>
    </div>

    <div id="modify-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg relative max-h-full overflow-y-auto">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-semibold mb-4">Modify Internship</h2>
            <form id="modify-internship-form">
                <input type="hidden" id="modify-internship-id">
                <div class="mb-4"><label for="modify-title" class="block text-gray-700 font-medium mb-2">Internship Title</label><input type="text" id="modify-title" class="w-full px-4 py-2 border rounded-lg" required></div>
                <div class="mb-4"><label for="modify-headline" class="block text-gray-700 font-medium mb-2">Headline</label><input type="text" id="modify-headline" class="w-full px-4 py-2 border rounded-lg" required></div>
                <div class="mb-4"><label for="modify-briefIntro" class="block text-gray-700 font-medium mb-2">Brief Intro</label><textarea id="modify-briefIntro" rows="2" class="w-full px-4 py-2 border rounded-lg" required></textarea></div>
                <div class="mb-4"><label for="modify-description" class="block text-gray-700 font-medium mb-2">Description</label><textarea id="modify-description" rows="4" class="w-full px-4 py-2 border rounded-lg" required></textarea></div>
                <div class="mb-4"><label for="modify-domain" class="block text-gray-700 font-medium mb-2">Domain</label><input type="text" id="modify-domain" class="w-full px-4 py-2 border rounded-lg" required></div>
                <div class="mb-4"><label for="modify-logoUrl" class="block text-gray-700 font-medium mb-2">Logo URL</label><input type="url" id="modify-logoUrl" class="w-full px-4 py-2 border rounded-lg"></div>
                <div class="mb-4"><label for="modify-brochureUrl" class="block text-gray-700 font-medium mb-2">Brochure URL</label><input type="url" id="modify-brochureUrl" class="w-full px-4 py-2 border rounded-lg"></div>
                <div class="border-t pt-4 mt-4">
                    <h3 class="text-xl font-semibold mb-4">Submission Form Fields</h3>
                    <div id="submission-fields-list" class="space-y-2 mb-4"></div>
                    <div class="flex gap-2 items-end">
                        <div class="flex-1"><label for="field-label" class="block text-sm font-medium text-gray-700">Field Label</label><input type="text" id="field-label" class="w-full px-3 py-2 border rounded-md" placeholder="e.g., GitHub Link"></div>
                        <div class="flex-1"><label for="field-type" class="block text-sm font-medium text-gray-700">Field Type</label><select id="field-type" class="w-full px-3 py-2 border rounded-md"><option value="text">Text</option><option value="url">URL</option><option value="file">File Upload</option></select></div>
                        <button type="button" id="add-field-btn" class="bg-indigo-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-600">Add Field</button>
                    </div>
                </div>
                <div class="text-right mt-6"><button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">Save Changes</button></div>
            </form>
        </div>
    </div>

    <div id="access-denied" class="hidden text-center p-16">
        <h1 class="text-4xl font-bold text-red-600">Access Denied</h1>
        <p class="text-xl mt-4">You do not have permission to view this page.</p>
        <a href="index.html" class="mt-8 inline-block bg-indigo-600 text-white py-3 px-6 rounded-lg">Go to Homepage</a>
    </div>
    
    <div id="message-box"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBrP14baJEyuYYt5xOUt4SeSeUFM3RY2rk",
        authDomain: "skilix.firebaseapp.com",
        projectId: "skilix",
        storageBucket: "skilix.appspot.com",
        messagingSenderId: "1042532384192",
        appId: "1:1042532384192:web:c0cc1939bb1ba8f7c69c25",
        measurementId: "G-H7LB645GR9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminDashboard = document.getElementById('admin-dashboard'), accessDenied = document.getElementById('access-denied'), internshipForm = document.getElementById('internship-form'), internshipsList = document.getElementById('internships-list'), usersList = document.getElementById('users-list'), messageBox = document.getElementById('message-box'), modifyModal = document.getElementById('modify-modal'), modifyForm = document.getElementById('modify-internship-form'), closeModalBtn = document.getElementById('close-modal-btn'), userSearchInput = document.getElementById('user-search'), submissionFieldsList = document.getElementById('submission-fields-list');
    let currentSubmissionFields = [], allUsersWithApps = [];

    function showMessage(message, isError = false) {
        messageBox.textContent = message;
        messageBox.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
        messageBox.classList.add('show');
        setTimeout(() => messageBox.classList.remove('show'), 3000);
    }

    async function checkAdminRole(user) {
        if (!user) { adminDashboard.classList.add('hidden'); accessDenied.classList.remove('hidden'); return false; }
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists() && userDoc.data().role === 'admin') {
            document.getElementById('admin-name').textContent = `Welcome, ${userDoc.data().name || user.displayName}`;
            adminDashboard.classList.remove('hidden');
            accessDenied.classList.add('hidden');
            return true;
        }
        adminDashboard.classList.add('hidden');
        accessDenied.classList.remove('hidden');
        return false;
    }
    
    async function loadInternships() {
        internshipsList.innerHTML = '<p>Loading internships...</p>';
        const querySnapshot = await getDocs(collection(db, "internships"));
        internshipsList.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const internship = doc.data(), internshipEl = document.createElement('div');
            internshipEl.className = 'border p-4 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center bg-gray-50';
            internshipEl.innerHTML = `
                <div class="flex items-start gap-4 flex-1"><img src="${internship.logoUrl || 'https://placehold.co/60x60/e0e7ff/4f46e5?text=Logo'}" alt="logo" class="w-12 h-12 rounded-md object-cover"><div class="flex-1"><h3 class="text-xl font-bold">${internship.title}</h3><p class="text-gray-600">${internship.domain}</p></div></div>
                <div class="flex gap-2 mt-4 md:mt-0"><button data-id="${doc.id}" class="modify-btn bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-600">Modify</button><button data-id="${doc.id}" class="delete-btn bg-red-500 text-white py-1 px-3 rounded hover:bg-red-600">Delete</button></div>`;
            internshipsList.appendChild(internshipEl);
        });
    }
    
    function renderSubmissionFields() {
        submissionFieldsList.innerHTML = '';
        if (currentSubmissionFields.length === 0) { submissionFieldsList.innerHTML = '<p class="text-gray-500 text-sm italic">No custom fields added yet.</p>'; return; }
        currentSubmissionFields.forEach((field, index) => {
            const fieldEl = document.createElement('div');
            fieldEl.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-md';
            fieldEl.innerHTML = `<p class="text-gray-800">${field.label} <span class="text-sm text-gray-500">(${field.type})</span></p><button type="button" class="remove-field-btn text-red-500 hover:text-red-700 font-bold text-xl" data-index="${index}">&times;</button>`;
            submissionFieldsList.appendChild(fieldEl);
        });
    }

    // --- MODIFIED FUNCTION ---
    function renderUsers(usersToRender, internshipsMap) {
        usersList.innerHTML = '';
        if (usersToRender.length === 0) { usersList.innerHTML = '<p>No users found with applications.</p>'; return; }

        usersToRender.forEach(user => {
            const userEl = document.createElement('div'), detailsId = `details-${user.uid}`;
            userEl.className = 'border p-4 rounded-lg bg-white';
            
            let applicationsHtml = '<p class="text-gray-500">No applications found for this user.</p>';
            if (user.applications && user.applications.length > 0) {
                applicationsHtml = user.applications.map((application) => {
                    const internship = internshipsMap.get(application.internshipId);
                    if (!internship) return '';
                    
                    const paymentStatusText = application.paymentStatus || 'pending';
                    const paymentStatusColor = paymentStatusText === 'paid' ? 'text-green-600' : 'text-red-600';

                    // NEW: Logic to display submissions from the map structure
                    let submissionsHtml = '';
                    if (application.submissions && Object.keys(application.submissions).length > 0) {
                        submissionsHtml = '<div class="mt-4 border-t pt-3"><h6 class="font-semibold text-sm text-gray-800">User Submissions:</h6>';
                        // Iterate over tasks (e.g., "Task 1", "Task 2")
                        for (const taskId in application.submissions) {
                            const submissionFields = application.submissions[taskId]; // This is an array of {label, value}
                            submissionsHtml += `<div class="mt-2 pl-2"><p class="font-medium text-sm">${taskId}:</p><ul class="list-disc list-inside text-sm space-y-1 pl-2 mt-1">`;
                            // Iterate over fields within the task
                            submissionFields.forEach(field => {
                                submissionsHtml += `<li><span>${field.label}:</span> <a href="${field.value}" target="_blank" class="text-blue-600 hover:underline break-all">${field.value}</a></li>`;
                            });
                            submissionsHtml += '</ul></div>';
                        }
                        submissionsHtml += '</div>';
                    } else {
                        submissionsHtml = '<p class="text-sm text-gray-500 mt-4 border-t pt-3">This user has not made any submissions yet.</p>';
                    }

                    return `
                        <div class="mt-4 pt-4 border-t">
                            <div class="flex justify-between items-center mb-2">
                                 <h5 class="font-semibold">${internship.title}</h5>
                                 <p class="text-sm font-bold">Status: <span class="${paymentStatusColor}">${paymentStatusText}</span></p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Offer Letter URL</label><input type="url" id="offer-${application.id}" value="${application.offerLetterUrl || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Certificate URL</label><input type="url" id="cert-${application.id}" value="${application.certificateUrl || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm"></div>
                            </div>
                            <div class="text-right mt-2"><button data-application-id="${application.id}" class="save-links-btn bg-blue-500 text-white text-sm py-1 px-3 rounded hover:bg-blue-600">Save Links</button></div>
                            ${submissionsHtml}
                        </div>`;
                }).join('');
            }

            userEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <div><h3 class="text-xl font-bold">${user.fullName || user.name || 'N/A'}</h3><p class="text-gray-600">${user.email}</p></div>
                    <button data-target="${detailsId}" class="toggle-details-btn bg-gray-200 text-gray-700 text-sm py-1 px-3 rounded-full hover:bg-gray-300">View Details</button>
                </div>
                <div id="${detailsId}" class="hidden mt-4 pt-4 border-t">
                    <h4 class="font-semibold mb-2">Personal Information:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                        <p><strong>Contact:</strong> ${user.contactNumber || 'N/A'}</p><p><strong>College:</strong> ${user.collegeName || 'N/A'}</p>
                    </div>
                    <h4 class="font-semibold mt-4">Applications:</h4>
                    ${applicationsHtml}
                </div>`;
            usersList.appendChild(userEl);
        });
    }

    async function loadUsersAndApplications() {
        usersList.innerHTML = '<p>Loading users...</p>';
        const [usersSnapshot, internshipsSnapshot, applicationsSnapshot] = await Promise.all([ getDocs(collection(db, "users")), getDocs(collection(db, "internships")), getDocs(collection(db, "applications")) ]);
        const internshipsMap = new Map();
        internshipsSnapshot.forEach(doc => internshipsMap.set(doc.id, doc.data()));
        const usersMap = new Map();
        usersSnapshot.forEach(doc => { if (doc.data().role !== 'admin') usersMap.set(doc.id, { ...doc.data(), uid: doc.id, applications: [] }); });
        applicationsSnapshot.forEach(appDoc => { const appData = appDoc.data(); if (usersMap.has(appData.userId)) usersMap.get(appData.userId).applications.push({ ...appData, id: appDoc.id }); });
        allUsersWithApps = Array.from(usersMap.values());
        renderUsers(allUsersWithApps, internshipsMap);
    }

    onAuthStateChanged(auth, async (user) => { if (await checkAdminRole(user)) { loadInternships(); loadUsersAndApplications(); } });

    userSearchInput.addEventListener('keyup', () => {
        const searchTerm = userSearchInput.value.toLowerCase();
        const filteredUsers = allUsersWithApps.filter(u => (u.fullName || u.name || '').toLowerCase().includes(searchTerm) || (u.email || '').toLowerCase().includes(searchTerm));
        getDocs(collection(db, "internships")).then(snap => { const iMap = new Map(); snap.forEach(doc => iMap.set(doc.id, doc.data())); renderUsers(filteredUsers, iMap); });
    });

    usersList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('toggle-details-btn')) { document.getElementById(e.target.dataset.target)?.classList.toggle('hidden'); }
        if (e.target.classList.contains('save-links-btn')) {
            const btn = e.target, appId = btn.dataset.applicationId;
            btn.disabled = true; btn.textContent = 'Saving...';
            await updateDoc(doc(db, "applications", appId), { offerLetterUrl: document.getElementById(`offer-${appId}`).value, certificateUrl: document.getElementById(`cert-${appId}`).value });
            showMessage('Links saved!');
            btn.disabled = false; btn.textContent = 'Save Links';
        }
    });
    
    internshipForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('add-internship-btn');
        btn.disabled = true; btn.textContent = 'Adding...';
        await addDoc(collection(db, "internships"), { title: document.getElementById('title').value, headline: document.getElementById('headline').value, briefIntro: document.getElementById('briefIntro').value, description: document.getElementById('description').value, domain: document.getElementById('domain').value, logoUrl: document.getElementById('logoUrl').value, createdAt: new Date() });
        showMessage('Internship added!');
        internshipForm.reset();
        loadInternships();
        btn.disabled = false; btn.textContent = 'Add Internship';
    });

    internshipsList.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.classList.contains('delete-btn') && confirm('Are you sure you want to delete this internship?')) { await deleteDoc(doc(db, "internships", id)); showMessage('Internship deleted.'); loadInternships(); }
        if (btn.classList.contains('modify-btn')) {
            const docSnap = await getDoc(doc(db, "internships", id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                document.getElementById('modify-internship-id').value = id;
                document.getElementById('modify-title').value = d.title;
                document.getElementById('modify-headline').value = d.headline || '';
                document.getElementById('modify-briefIntro').value = d.briefIntro || '';
                document.getElementById('modify-description').value = d.description;
                document.getElementById('modify-domain').value = d.domain;
                document.getElementById('modify-logoUrl').value = d.logoUrl || '';
                document.getElementById('modify-brochureUrl').value = d.brochureUrl || '';
                currentSubmissionFields = d.submissionFields || [];
                renderSubmissionFields();
                modifyModal.classList.remove('hidden');
            }
        }
    });
    
    modifyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('modify-internship-id').value;
        await updateDoc(doc(db, "internships", id), { title: document.getElementById('modify-title').value, headline: document.getElementById('modify-headline').value, briefIntro: document.getElementById('modify-briefIntro').value, description: document.getElementById('modify-description').value, domain: document.getElementById('modify-domain').value, logoUrl: document.getElementById('modify-logoUrl').value, brochureUrl: document.getElementById('modify-brochureUrl').value, submissionFields: currentSubmissionFields });
        showMessage('Internship updated!');
        modifyModal.classList.add('hidden');
        loadInternships();
    });

    closeModalBtn.addEventListener('click', () => modifyModal.classList.add('hidden'));
    
    modifyModal.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-field-btn');
        if (removeBtn) { currentSubmissionFields.splice(parseInt(removeBtn.dataset.index, 10), 1); renderSubmissionFields(); return; }
        const addBtn = e.target.closest('#add-field-btn');
        if (addBtn) {
            const labelInput = document.getElementById('field-label');
            if (!labelInput.value.trim()) { showMessage('Label cannot be empty.', true); return; }
            currentSubmissionFields.push({ label: labelInput.value.trim(), type: document.getElementById('field-type').value });
            renderSubmissionFields();
            labelInput.value = '';
        }
    });
</script>
</body>
</html>
