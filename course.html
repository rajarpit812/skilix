<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skilix - My Course</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .container { max-width: 900px; }
        #message-box {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); padding: 12px 24px;
            border-radius: 8px; color: white; z-index: 100;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #message-box.show { opacity: 1; visibility: visible; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
            <a href="index.html" class="font-bold text-2xl tracking-tight">Skil<span class="text-indigo-600">ix</span></a>
            <div>
                <a href="profile.html" class="text-gray-600 hover:text-indigo-600 mr-6">My Profile</a>
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-full hover:bg-red-600">
                    Logout
                </button>
            </div>
        </nav>
    </header>

    <main id="main-content" class="container mx-auto py-12 px-6 hidden">
        <div class="space-y-8">
            <section class="bg-white rounded-lg shadow-lg p-8 border border-gray-200">
                <h1 id="internship-title" class="text-3xl md:text-4xl font-extrabold text-gray-900"></h1>
                <p id="internship-domain" class="text-lg text-indigo-600 font-semibold mt-1"></p>
                <p id="internship-headline" class="mt-4 text-gray-600"></p>
                <a id="brochure-link" href="#" target="_blank" class="hidden mt-4 inline-block text-indigo-600 font-semibold hover:underline">
                    Download Brochure &rarr;
                </a>
            </section>

            <section class="bg-white rounded-lg shadow-lg p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Task Submission</h2>
                <form id="submission-form">
                    <div id="dynamic-form-fields" class="space-y-6">
                        </div>
                    <div class="mt-8 text-right flex justify-end items-center gap-4">
                         <button type="button" id="edit-submission-btn" class="hidden bg-gray-500 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-gray-600">
                            Edit
                        </button>
                         <button type="submit" id="save-submission-btn" class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700">
                            Save Submission
                        </button>
                    </div>
                </form>
            </section>
            
            <section id="payment-section" class="hidden bg-white rounded-lg shadow-lg p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Payment</h2>
                <div id="payment-details">
                     <p id="course-fee-text" class="text-lg font-semibold text-gray-800">Course Fee: â‚¹0.00</p>
                     <p id="payment-status-text" class="mt-2 text-sm font-medium"></p>
                     <button id="pay-btn" class="w-full max-w-xs mt-4 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-transform hover:scale-105" disabled>
                        Pay Now
                    </button>
                </div>
            </section>

            <section id="certificate-section" class="hidden bg-white rounded-lg shadow-lg p-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Completion Certificate</h2>
                <p class="text-gray-600 mb-4">Congratulations! You can now download your certificate.</p>
                <a id="certificate-link" href="#" target="_blank" class="w-full max-w-xs text-center block bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700">
                    Download Certificate
                </a>
            </section>
        </div>
    </main>

    <div id="loading-state" class="text-center py-24">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-gray-600">Loading your course details...</p>
    </div>
    <div id="access-denied" class="hidden text-center py-24">
        <h1 class="text-4xl font-bold text-red-600">Access Denied</h1>
        <p class="text-xl mt-4">You do not have permission to view this page or the application is invalid.</p>
        <a href="profile.html" class="mt-8 inline-block bg-indigo-600 text-white py-3 px-6 rounded-lg">Go to My Profile</a>
    </div>

    <div id="message-box"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrP14baJEyuYYt5xOUt4SeSeUFM3RY2rk",
            authDomain: "skilix.firebaseapp.com",
            projectId: "skilix",
            storageBucket: "skilix.appspot.com",
            messagingSenderId: "1042532384192",
            appId: "1:1042532384192:web:c0cc1939bb1ba8f7c69c25",
            measurementId: "G-H7LB645GR9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const mainContent = document.getElementById('main-content');
        const loadingState = document.getElementById('loading-state');
        const accessDenied = document.getElementById('access-denied');
        const messageBox = document.getElementById('message-box');
        const submissionForm = document.getElementById('submission-form');
        const saveSubmissionBtn = document.getElementById('save-submission-btn');
        const editSubmissionBtn = document.getElementById('edit-submission-btn');
        const payBtn = document.getElementById('pay-btn');

        const showMessage = (message, isError = false) => {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 3000);
        };

        const setFormInputsDisabled = (isDisabled) => {
            const inputs = submissionForm.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = isDisabled;
            });
        };

        const lockSubmissionForm = () => {
            setFormInputsDisabled(true);
            saveSubmissionBtn.classList.add('hidden');
            editSubmissionBtn.classList.remove('hidden');
        };

        const unlockSubmissionForm = () => {
            setFormInputsDisabled(false);
            saveSubmissionBtn.classList.remove('hidden');
            editSubmissionBtn.classList.add('hidden');
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const applicationId = params.get("id");

            if (!applicationId) {
                loadingState.classList.add('hidden');
                accessDenied.classList.remove('hidden');
                return;
            }

            try {
                const appRef = doc(db, "applications", applicationId);
                const appSnap = await getDoc(appRef);

                if (!appSnap.exists() || appSnap.data().userId !== user.uid) {
                    loadingState.classList.add('hidden');
                    accessDenied.classList.remove('hidden');
                    return;
                }

                const application = appSnap.data();
                
                const internshipRef = doc(db, "internships", application.internshipId);
                const userProfileRef = doc(db, "users", user.uid);
                const [internshipSnap, userProfileSnap] = await Promise.all([getDoc(internshipRef), getDoc(userProfileRef)]);
                
                if (!internshipSnap.exists()) {
                    throw new Error("Internship data not found.");
                }

                const internship = internshipSnap.data();
                const userProfile = userProfileSnap.data() || {};
                
                renderPage(application, internship, user, userProfile);
                
                loadingState.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (error) {
                console.error("Error loading page:", error);
                loadingState.innerHTML = `<p class="text-red-500 font-bold">Error: ${error.message}</p>`;
            }
        });

        function renderPage(application, internship, user, userProfile) {
            document.getElementById("internship-title").textContent = internship.title;
            document.getElementById("internship-domain").textContent = internship.domain;
            document.getElementById("internship-headline").textContent = internship.headline;
            if (internship.brochureUrl) {
                const brochureLink = document.getElementById("brochure-link");
                brochureLink.href = internship.brochureUrl;
                brochureLink.classList.remove('hidden');
            }

            const hasSubmissions = application.submissions && Object.keys(application.submissions).length > 0;
            const internshipFee = parseInt(internship.fee, 10);

            if (internshipFee > 0) {
                document.getElementById('payment-section').classList.remove('hidden');
                updatePaymentSection(application.paymentStatus, internshipFee, hasSubmissions);
                payBtn.addEventListener('click', () => {
                    handlePayment(application, internship, user, userProfile);
                });
            } else {
                 document.getElementById('payment-section').classList.add('hidden');
            }

            if (application.certificateUrl) {
                document.getElementById('certificate-section').classList.remove('hidden');
                document.getElementById('certificate-link').href = application.certificateUrl;
            }

            renderSubmissionForm(internship.submissionFields || [], application.submissions || {});
            
            if (hasSubmissions) {
                lockSubmissionForm();
            }

            submissionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSubmission(internshipFee, application.paymentStatus);
            });

            editSubmissionBtn.addEventListener('click', unlockSubmissionForm);
        }
        
        function updatePaymentSection(status, fee, isFormSubmitted) {
            const statusText = document.getElementById('payment-status-text');
            const feeText = document.getElementById('course-fee-text');

            feeText.textContent = `Course Fee: â‚¹${fee}.00`;

            if (status === 'paid') {
                statusText.textContent = 'Payment Successful âœ…';
                statusText.className = 'mt-2 text-sm font-medium text-green-600';
                payBtn.textContent = 'Paid';
                payBtn.disabled = true;
                payBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                payBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            } else {
                statusText.textContent = 'Your payment is pending.';
                statusText.className = 'mt-2 text-sm font-medium text-amber-600';
                payBtn.disabled = !isFormSubmitted;
                if (!isFormSubmitted) {
                    payBtn.title = "Please submit your tasks before paying.";
                    payBtn.classList.add('cursor-not-allowed', 'bg-gray-400');
                    payBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                } else {
                    payBtn.title = "";
                    payBtn.classList.remove('cursor-not-allowed', 'bg-gray-400');
                    payBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                }
            }
        }
        
        function renderSubmissionForm(fields, existingSubmissions) {
            const container = document.getElementById('dynamic-form-fields');
            container.innerHTML = '';
            
            if (!fields || fields.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No submission tasks required for this internship.</p>';
                 saveSubmissionBtn.classList.add('hidden');
                return;
            }
            
            fields.forEach(field => {
                const fieldId = `field-${field.label.replace(/\s+/g, '-')}`;
                const value = existingSubmissions[field.label] || '';
                
                const fieldWrapper = document.createElement('div');
                let inputHtml = '';

                if (field.type === 'file') {
                    inputHtml = `<input type="file" id="${fieldId}" name="${field.label}" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">`;
                } else {
                    inputHtml = `<input type="${field.type === 'url' ? 'url' : 'text'}" id="${fieldId}" name="${field.label}" value="${value}" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter ${field.label}" required>`;
                }

                fieldWrapper.innerHTML = `
                    <label for="${fieldId}" class="block text-gray-700 font-medium mb-2">${field.label}</label>
                    ${inputHtml}
                `;
                container.appendChild(fieldWrapper);
            });
        }
        
        async function handleSubmission(fee, paymentStatus) {
            const formData = new FormData(submissionForm);
            const submissionData = {};

            for (const [key, value] of formData.entries()) {
                if (value instanceof File) {
                    submissionData[key] = value.name;
                } else {
                    submissionData[key] = value;
                }
            }
            
            saveSubmissionBtn.disabled = true;
            saveSubmissionBtn.textContent = 'Saving...';

            try {
                const applicationId = new URLSearchParams(window.location.search).get("id");
                const appRef = doc(db, "applications", applicationId);
                await updateDoc(appRef, {
                    submissions: submissionData
                });
                showMessage('Your submission has been saved successfully!');
                lockSubmissionForm();
                if (fee > 0) {
                    updatePaymentSection(paymentStatus, fee, true);
                }
            } catch (error) {
                console.error("Error saving submission:", error);
                showMessage('There was an error saving your submission.', true);
            } finally {
                saveSubmissionBtn.disabled = false;
                saveSubmissionBtn.textContent = 'Save Submission';
            }
        }
        
        async function handlePayment(application, internship, user, userProfile) {
            payBtn.disabled = true;
            payBtn.textContent = 'Processing...';

            const amountInPaise = parseInt(internship.fee, 10) * 100;

            let order;
            try {
                const response = await fetch('https://skilix-backend.onrender.com/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amountInPaise, currency: 'INR' })
                });
                if (!response.ok) throw new Error('Failed to create order.');
                order = await response.json();
            } catch (error) {
                console.error("Order creation failed:", error);
                showMessage("Payment failed: Could not connect to the server.", true);
                payBtn.disabled = false;
                payBtn.textContent = 'Pay Now';
                return;
            }

            const options = {
                key: "rzp_live_R8XAgH7yeD9jKC", 
                amount: order.amount,
                currency: "INR",
                name: "Skilix",
                description: `Payment for ${internship.title}`,
                order_id: order.id,
                handler: async function (response) {
                    try {
                        const verificationResponse = await fetch('https://skilix-backend.onrender.com/verify-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature,
                            })
                        });

                        if (!verificationResponse.ok) throw new Error('Payment verification failed.');
                        
                        const result = await verificationResponse.json();

                        if (result.status === 'success') {
                            const applicationId = new URLSearchParams(window.location.search).get("id");
                            const appRef = doc(db, "applications", applicationId);
                            await updateDoc(appRef, {
                                paymentStatus: "paid",
                                paymentId: response.razorpay_payment_id,
                                orderId: response.razorpay_order_id
                            });
                            showMessage("Payment successful!");
                            updatePaymentSection('paid', parseInt(internship.fee, 10), true);
                        } else {
                            throw new Error('Signature verification returned failure.');
                        }

                    } catch(err) {
                        console.error("Verification or DB update failed:", err);
                        showMessage("Payment verification failed. Please contact support.", true);
                    }
                },
                prefill: {
                    name: userProfile.fullName || user.displayName,
                    email: user.email,
                    contact: userProfile.contactNumber || ""
                },
                notes: {
                    applicationId: new URLSearchParams(window.location.search).get("id"),
                    userId: user.uid
                },
                theme: {
                    color: "#4f46e5"
                }
            };
            const rzp = new Razorpay(options);
            rzp.on('payment.failed', function (response){
                showMessage(`Payment failed: ${response.error.description}`, true);
                payBtn.disabled = false;
                payBtn.textContent = 'Pay Now';
            });
            rzp.open();
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).catch((error) => console.error('Sign out error', error));
        });
    </script>
</body>
</html>
